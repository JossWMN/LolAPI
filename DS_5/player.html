<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <title>Player | LoLInsight</title>
    <style>
        /* perfil de jugador */
        .perfil-of-player {
            background-color: #2a2a4a;
            margin: 20px;
            padding: 20px;
            border-radius: 10px;
        }
        
        .perfil-datos h2 {
            color: #4d8ee1;
        }
        
        .perfil-datos p {
            font-size: 18px;
            margin: 5px 0;
        }
        
        
        /* Partidas */
        .historial-partidas {
            background-color: #2a2a4a;
            margin: 20px;
            padding: 20px;
            border-radius: 10px;
        }
        
        .historial-partidas h3 {
            color: #4d8ee1;
            text-align: center;
        }
        
        .partida-item {
            background-color: #1a1a2e;
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid #3066be;
        }
        
        .partida-item.ganada {
            border-left-color: green;
        }
        
        .partida-item.perdida {
            border-left-color: red;
        }
        
        .kda {
            color: #ffcc00;
            font-weight: bold;
        }
        
        .cargando {
            text-align: center;
            color: #888;
            padding: 20px;
        }
    </style>
</head>
<body class="body">
<!-- BANNER -->
    <header class="banner">
        <img src="image/banner.png" alt="Banner">
    </header>

    <!-- NAVBAR -->
    <nav class="navbar">
        <ul>
            <li><a href="index.html">INICIO</a></li>
            <li><a href="champions.html">CHAMPIONS</a></li>
            <li><a class="active" href="player.html">PLAYER</a></li>
            <li><a href="items.html">ITEMS</a></li>
            <li><a href="#sobre-nosotros">SOBRE NOSOTROS</a></li>
        </ul>
    </nav>

    <!-- Buscador -->
<div class="busqueda">
    <div class="search-box">
        <input type="text" id="BuscarInput" placeholder="Nombre del jugador">
        <input type="text" id="tagLineInput" placeholder="Etiqueta (ej: LAS)">
        <button onclick="buscarJugador()">Buscar</button>
    </div>

    <!-- Filtro de partidas -->
    <select id="roleFiltro">
        <option value="all">Todos</option>
        <option value="solo">SoloQ</option>
        <option value="flex">Flex</option>
        <option value="draf">Normal</option>
    </select>
</div>

<!-- Perfil del jugador -->
<section class="perfil-of-player">
    <div class="perfil-img">
        <img id="profileIcon" src="" alt="Icono">
    </div>
    <div class="perfil-datos">
        <h2 id="playerGameName">Nombre</h2>
        <p id="playerLevel">Nivel: 0</p>
        <p id="playerRank">SoloQ: No hay rango</p>
        <p id="playerFlex">Flex: No hay rango</p>
    </div>
</section>

<!-- Historial de partidas -->
<section class="historial-partidas" id="historialPartidas">
    <h3>Últimas Partidas</h3>
    <div id="partidasContainer">
        <div class="cargando">Busca un jugador para ver sus partidas</div>
    </div>
</section>

<script>
    // API Key
    const API_KEY = "RGAPI-4bd2c667-87ab-476c-931f-e692bd098c81";
    
    // Guardamos datos del jugador
    let puuidJugador = null; // <= Esta variable es IMPORTANTE, porque guarda el PUUID del jugador
    let regionJugador = "";
    let tagRegion = "";
    
    // Función cuando apretas Buscar
    async function buscarJugador() {
        // Sacar lo que escribiste
        const nombre = document.getElementById("BuscarInput").value.trim();
        const tag = document.getElementById("tagLineInput").value.trim();
        const filtro = document.getElementById("roleFiltro").value;
        
        // Ver si escribiste algo
        if (!nombre || !tag) {
            alert("Escribe nombre y etiqueta");
            return;
        }
        
        tagRegion = tag.toUpperCase();
        
        // Poner "cargando"
        document.getElementById("playerGameName").textContent = "Buscando...";
        document.getElementById("playerLevel").textContent = "Nivel: ...";
        document.getElementById("playerRank").textContent = "SoloQ: ...";
        document.getElementById("playerFlex").textContent = "Flex: ...";
        
        try {
            console.log("1. Buscando PUUID...");
            // A - Buscar ID del jugador
            puuidJugador = await buscarPUUID(nombre, tag); // <= Guardamps aqui
            console.log("PUUID encontrado:", puuidJugador);
            
            // B - Determinar región
            regionJugador = determinarRegion(tag);
            console.log("Región determinada:", regionJugador);
            
            console.log("2. Obteniendo datos del jugador...");
            // C - Obtener datos del jugador
            const datosJugador = await obtenerDatosJugador(puuidJugador, regionJugador);
            console.log("ID del jugador para rango:", datosJugador.id);
            
            console.log("3. Obteniendo rango...");
            // D - Obtener rango 
            const datosRango = await obtenerRango(datosJugador.id, regionJugador);
            console.log("Datos rango recibidos:", datosRango);
            
            // E - Mostrar todo
            mostrarPerfil(nombre, tag, datosJugador, datosRango);
            
            console.log("4. Obteniendo partidas...");
            // F - Obtener y mostrar partidas
            const partidas = await obtenerPartidas(puuidJugador, filtro);
            console.log("IDs de partidas:", partidas);
            await mostrarPartidas(partidas);
            
        } catch (error) {
            console.error("Error completo:", error);
            alert("Error: " + error.message);
            document.getElementById("playerGameName").textContent = "Error";
        }
    }
    
    // Determinar región del jugador
    function determinarRegion(tag) {
        const tagUpper = tag.toUpperCase();
        
        if (tagUpper === "LAN") return "la1";
        if (tagUpper === "LAS") return "la2";
        if (tagUpper === "NA" || tagUpper === "NA1") return "na1";
        if (tagUpper === "BR" || tagUpper === "BR1") return "br1";
        if (tagUpper === "EUW") return "euw1";
        if (tagUpper === "EUNE") return "eun1";
        if (tagUpper === "KR") return "kr";
        if (tagUpper === "RU") return "ru";
        if (tagUpper === "TR") return "tr1";
        if (tagUpper === "OCE" || tagUpper === "OC1") return "oc1";
        if (tagUpper === "JP" || tagUpper === "JP1") return "jp1";
        
        console.log("Tag no reconocido, usando LAS por defecto");
        return "la2";
    }
    
    // Buscar ID del jugador
    async function buscarPUUID(nombre, tag) {
        const url = `https://americas.api.riotgames.com/riot/account/v1/accounts/by-riot-id/${nombre}/${tag}?api_key=${API_KEY}`;
        
        const respuesta = await fetch(url);
        
        if (!respuesta.ok) {
            if (respuesta.status === 403) {
                throw new Error("API Key mala o expirada. Genera una nueva");
            }
            if (respuesta.status === 404) {
                throw new Error("Jugador no encontrado");
            }
            throw new Error("Error al buscar jugador");
        }
        
        const datos = await respuesta.json();
        return datos.puuid;
    }
    
    // Obtener datos del jugador
    async function obtenerDatosJugador(puuid, region) {
        const url = `https://${region}.api.riotgames.com/lol/summoner/v4/summoners/by-puuid/${puuid}?api_key=${API_KEY}`;
        
        const respuesta = await fetch(url);
        if (!respuesta.ok) {
            throw new Error("Error al obtener datos del jugador");
        }
        
        return await respuesta.json();
    }
    
    // OBTENER RANGO con el endpoint correcto.
    async function obtenerRango(idJugador, region) {
        // URL CORREGIDA: usando el endpoint correcto 'by-summoner'
        const url = `https://${region}.api.riotgames.com/lol/league/v4/entries/by-summoner/${idJugador}?api_key=${API_KEY}`;
        console.log("URL para rango:", url);
        
        const respuesta = await fetch(url);
        if (!respuesta.ok) {
            console.log("Error al obtener rango, status:", respuesta.status);
            return []; // Devuelve array vacío si no hay rango
        }
        
        return await respuesta.json();
    }
    
    // Obtener partidas
    async function obtenerPartidas(puuid, tipo) {
        let tipoPartida = "";
        
        if (tipo === "solo") tipoPartida = "ranked";
        else if (tipo === "flex") tipoPartida = "ranked_flex";
        else if (tipo === "draf") tipoPartida = "normal";
        
        // Determinar cluster regional para partidas
        let clusterRegional = "americas";
        
        if (regionJugador === "la1" || regionJugador === "la2" || 
            regionJugador === "na1" || regionJugador === "br1") {
            clusterRegional = "americas";
        } else if (regionJugador === "euw1" || regionJugador === "eun1" || 
                   regionJugador === "ru" || regionJugador === "tr1") {
            clusterRegional = "europe";
        } else if (regionJugador === "kr" || regionJugador === "jp1") {
            clusterRegional = "asia";
        } else if (regionJugador === "oc1") {
            clusterRegional = "sea";
        }
        
        let url = "";
        
        if (tipoPartida) {
            url = `https://${clusterRegional}.api.riotgames.com/lol/match/v5/matches/by-puuid/${puuid}/ids?type=${tipoPartida}&start=0&count=3&api_key=${API_KEY}`;
        } else {
            url = `https://${clusterRegional}.api.riotgames.com/lol/match/v5/matches/by-puuid/${puuid}/ids?start=0&count=3&api_key=${API_KEY}`;
        }
        
        console.log("URL para partidas:", url);
        
        const respuesta = await fetch(url);
        if (!respuesta.ok) {
            console.log("Error al obtener partidas:", respuesta.status);
            return [];
        }
        
        return await respuesta.json();
    }
    
    // Mostrar perfil
    function mostrarPerfil(nombre, tag, datosJugador, datosRango) {
        // Mostrar nombre
        document.getElementById("playerGameName").textContent = nombre + "#" + tag;
        
        // Mostrar nivel
        document.getElementById("playerLevel").textContent = "Nivel: " + datosJugador.summonerLevel;
        
        // Mostrar icono
        const icono = document.getElementById("profileIcon");
        if (icono && datosJugador.profileIconId) {
            icono.src = `https://ddragon.leagueoflegends.com/cdn/14.23.1/img/profileicon/${datosJugador.profileIconId}.png`;
        }
        
        // Inicializar rangos
        let soloq = "No rankeado";
        let flex = "No rankeado";
        
        // Si hay datos de rango
        if (datosRango && Array.isArray(datosRango)) {
            for (let i = 0; i < datosRango.length; i++) {
                const r = datosRango[i];
                
                // SoloQ
                if (r.queueType === "RANKED_SOLO_5x5") {
                    soloq = r.tier + " " + r.rank + " (" + r.leaguePoints + " LP)";
                }
                
                // Flex
                if (r.queueType === "RANKED_FLEX_SR") {
                    flex = r.tier + " " + r.rank + " (" + r.leaguePoints + " LP)";
                }
            }
        }
        
        // Mostrar rangos
        document.getElementById("playerRank").textContent = "SoloQ: " + soloq;
        document.getElementById("playerFlex").textContent = "Flex: " + flex;
    }
    
    // Mostrar partidas recientes
    async function mostrarPartidas(idsPartidas) {
        const container = document.getElementById("partidasContainer");
        
        if (!idsPartidas || idsPartidas.length === 0) {
            container.innerHTML = '<div class="cargando">No hay partidas recientes</div>';
            return;
        }
        
        let html = "";
        
        for (let i = 0; i < Math.min(2, idsPartidas.length); i++) {
            try {
                const partida = await obtenerDetallesPartida(idsPartidas[i]);
                
                if (partida && partida.info && partida.info.participants) {
                    // Buscar al jugador usando puuidJugador
                    let jugador = null;
                    for (let p of partida.info.participants) {
                        if (p.puuid === puuidJugador) { // Usando el puuidJugador
                            jugador = p;
                            break;
                        }
                    }
                    
                    if (jugador) {
                        const ganada = jugador.win ? "ganada" : "perdida";
                        const resultado = jugador.win ? 'GANÓ' : 'PERDIÓ';
                        
                        html += `
                            <div class="partida-item ${ganada}">
                                <div><strong>${resultado}</strong></div>
                                <div>Campeón: ${jugador.championName || "Desconocido"}</div>
                                <div class="kda">K/D/A: ${jugador.kills}/${jugador.deaths}/${jugador.assists}</div>
                                <div>CS: ${jugador.totalMinionsKilled || 0}</div>
                            </div>
                        `;
                    }
                }
            } catch (e) {
                console.log("Error en partida:", e);
                html += '<div class="partida-item error">Error cargando partida</div>';
            }
        }
        
        container.innerHTML = html || '<div class="cargando">Error en partidas</div>';
    }
    
    // Obtener detalles de partida
    async function obtenerDetallesPartida(matchId) {
        // Determinar cluster (igual que en obtenerPartidas)
        let clusterRegional = "americas";
        
        if (regionJugador === "la1" || regionJugador === "la2" || 
            regionJugador === "na1" || regionJugador === "br1") {
            clusterRegional = "americas";
        } else if (regionJugador === "euw1" || regionJugador === "eun1" || 
                   regionJugador === "ru" || regionJugador === "tr1") {
            clusterRegional = "europe";
        } else if (regionJugador === "kr" || regionJugador === "jp1") {
            clusterRegional = "asia";
        } else if (regionJugador === "oc1") {
            clusterRegional = "sea";
        }
        
        const url = `https://${clusterRegional}.api.riotgames.com/lol/match/v5/matches/${matchId}?api_key=${API_KEY}`;
        
        const respuesta = await fetch(url);
        if (!respuesta.ok) {
            console.log("Error en detalles partida:", respuesta.status);
            return null;
        }
        
        return await respuesta.json();
    }
    
    // Filtrar partidas
    document.getElementById('roleFiltro').addEventListener('change', function() {
        if (puuidJugador) {
            const filtro = this.value;
            obtenerPartidas(puuidJugador, filtro).then(mostrarPartidas);
        }
    });

console.log("Script cargado. API Key:", API_KEY ? "Sí" : "No");

</script>
</body>
</html>